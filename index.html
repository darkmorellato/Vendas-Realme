<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Executivo - Análise de Vendas Realme</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts - Plus Jakarta Sans (More enterprise/tech look) -->
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['"Plus Jakarta Sans"', 'sans-serif'],
                    },
                    colors: {
                        brand: {
                            50: '#eff6ff',
                            100: '#dbeafe',
                            500: '#3b82f6',
                            600: '#2563eb',
                            700: '#1d4ed8',
                            900: '#1e3a8a',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background-color: #f8fafc; /* Slate-50 */
        }
        .glass-effect {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
        }
        .card-hover {
            transition: all 0.3s ease;
        }
        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        /* Custom Select Style */
        .custom-select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
        }
    </style>
</head>
<body class="text-slate-800 antialiased">

    <!-- Top Navigation Bar -->
    <nav class="bg-white border-b border-slate-200 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center gap-3">
                    <div class="bg-brand-600 p-2 rounded-lg">
                        <i data-lucide="bar-chart-2" class="text-white h-6 w-6"></i>
                    </div>
                    <span class="text-xl font-bold text-slate-900 tracking-tight">Análise de Vendas Realme</span>
                </div>
                <div class="flex items-center gap-4">
                    <!-- Period Selector -->
                    <div class="relative">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <i data-lucide="calendar" class="h-4 w-4 text-slate-500"></i>
                        </div>
                        <select id="period-selector" class="custom-select bg-slate-50 border border-slate-300 text-slate-900 text-sm rounded-lg focus:ring-brand-500 focus:border-brand-500 block w-full pl-10 p-2.5 font-medium">
                            <option value="nov2025" selected>Novembro 2025</option>
                            <option value="out2025">Outubro 2025</option>
                        </select>
                    </div>
                    
                    <div class="h-8 w-8 rounded-full bg-brand-100 flex items-center justify-center text-brand-700 font-bold text-sm border border-brand-200">
                        RM
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 space-y-8">
        
        <!-- Header Section -->
        <div class="flex flex-col md:flex-row md:items-end justify-between gap-4">
            <div>
                <h2 class="text-2xl font-bold text-slate-900" id="page-title">Visão Geral - Novembro</h2>
                <p class="text-slate-500 mt-1">Resumo estratégico do desempenho de vendas.</p>
            </div>
            <div>
                <span id="last-updated" class="text-xs text-slate-400">Dados processados em tempo real</span>
            </div>
        </div>

        <!-- KPI Cards Section -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <!-- Card 1 -->
            <div class="bg-white rounded-xl border border-slate-200 p-6 card-hover shadow-sm">
                <div class="flex items-center justify-between mb-4">
                    <div class="p-3 bg-blue-50 rounded-lg">
                        <i data-lucide="shopping-bag" class="h-6 w-6 text-blue-600"></i>
                    </div>
                    <!-- Placeholder for MoM growth calculation if needed in future -->
                    <span id="growth-badge" class="text-xs font-semibold text-slate-500 bg-slate-100 px-2 py-1 rounded-full">Mensal</span>
                </div>
                <div>
                    <p class="text-sm font-medium text-slate-500">Volume Total de Vendas</p>
                    <h3 id="total-items" class="text-3xl font-bold text-slate-900 mt-1">...</h3>
                </div>
            </div>

            <!-- Card 2 -->
            <div class="bg-white rounded-xl border border-slate-200 p-6 card-hover shadow-sm">
                <div class="flex items-center justify-between mb-4">
                    <div class="p-3 bg-indigo-50 rounded-lg">
                        <i data-lucide="layers" class="h-6 w-6 text-indigo-600"></i>
                    </div>
                    <span class="text-xs font-semibold text-slate-500">Mix de Produtos</span>
                </div>
                <div>
                    <p class="text-sm font-medium text-slate-500">Produtos Únicos Vendidos</p>
                    <h3 id="unique-products" class="text-3xl font-bold text-slate-900 mt-1">...</h3>
                </div>
            </div>

            <!-- Card 3 -->
            <div class="bg-white rounded-xl border border-slate-200 p-6 card-hover shadow-sm">
                <div class="flex items-center justify-between mb-4">
                    <div class="p-3 bg-purple-50 rounded-lg">
                        <i data-lucide="trending-up" class="h-6 w-6 text-purple-600"></i>
                    </div>
                    <span class="text-xs font-semibold text-purple-600 bg-purple-50 px-2 py-1 rounded-full">Top Performer</span>
                </div>
                <div>
                    <p class="text-sm font-medium text-slate-500">Item Mais Vendido</p>
                    <h3 id="top-product-name" class="text-lg font-bold text-slate-900 mt-1 truncate" title="">...</h3>
                </div>
            </div>
        </div>

        <!-- Charts Section -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Pie Chart -->
            <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm flex flex-col">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-lg font-bold text-slate-900">Distribuição do Mix</h3>
                    <button class="text-slate-400 hover:text-slate-600"><i data-lucide="more-horizontal" class="h-5 w-5"></i></button>
                </div>
                <div class="relative flex-grow flex items-center justify-center min-h-[300px]">
                    <canvas id="productPieChart"></canvas>
                </div>
            </div>

            <!-- Bar Chart -->
            <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm flex flex-col">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-lg font-bold text-slate-900">Top 10 Produtos (Volume)</h3>
                    <button class="text-slate-400 hover:text-slate-600"><i data-lucide="more-horizontal" class="h-5 w-5"></i></button>
                </div>
                <div class="relative flex-grow flex items-center justify-center min-h-[300px]">
                    <canvas id="productBarChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Detailed Legend (Grid) -->
        <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
             <div class="flex items-center gap-2 mb-4">
                <i data-lucide="list" class="h-5 w-5 text-slate-400"></i>
                <h3 class="text-lg font-bold text-slate-900">Legenda Detalhada</h3>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4" id="pie-legend-container">
                <!-- Javascript will populate -->
            </div>
        </div>

        <!-- Data Table Section -->
        <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
            <div class="p-6 border-b border-slate-100 flex flex-col sm:flex-row sm:items-center justify-between gap-4">
                <div>
                    <h3 class="text-lg font-bold text-slate-900">Detalhamento de Vendas</h3>
                    <p class="text-sm text-slate-500">Lista completa de todos os itens transacionados.</p>
                </div>
                
                <!-- Search Bar -->
                <div class="relative">
                    <i data-lucide="search" class="absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-slate-400"></i>
                    <input type="text" id="table-search" placeholder="Buscar produto..." class="pl-10 pr-4 py-2 border border-slate-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-brand-500 focus:border-brand-500 w-full sm:w-64">
                </div>
            </div>
            
            <div class="overflow-x-auto">
                <table class="w-full text-left text-sm text-slate-600">
                    <thead class="bg-slate-50 text-xs uppercase font-semibold text-slate-500">
                        <tr>
                            <th class="px-6 py-4 text-center w-16">#</th>
                            <th id="sort-by-name" class="px-6 py-4 cursor-pointer hover:bg-slate-100 transition-colors group">
                                <div class="flex items-center gap-1">
                                    Produto
                                    <i data-lucide="arrow-up-down" class="h-3 w-3 opacity-0 group-hover:opacity-50 transition-opacity"></i>
                                </div>
                            </th>
                            <th id="sort-by-quantity" class="px-6 py-4 text-center cursor-pointer hover:bg-slate-100 transition-colors group">
                                <div class="flex items-center justify-center gap-1">
                                    Qtd.
                                    <i data-lucide="arrow-up-down" class="h-3 w-3 opacity-0 group-hover:opacity-50 transition-opacity"></i>
                                </div>
                            </th>
                            <th id="sort-by-percentage" class="px-6 py-4 text-center cursor-pointer hover:bg-slate-100 transition-colors group">
                                <div class="flex items-center justify-center gap-1">
                                    Share (%)
                                    <i data-lucide="arrow-up-down" class="h-3 w-3 opacity-0 group-hover:opacity-50 transition-opacity"></i>
                                </div>
                            </th>
                            <th class="px-6 py-4 text-center">Status</th>
                        </tr>
                    </thead>
                    <tbody id="product-table-body" class="divide-y divide-slate-100">
                        <!-- Javascript populates this -->
                    </tbody>
                </table>
            </div>
            <!-- Simple Pagination Mockup -->
            <div class="px-6 py-4 border-t border-slate-100 flex items-center justify-between text-sm text-slate-500">
                <span id="showing-text">Mostrando todos os resultados</span>
                <div class="flex gap-2">
                    <button class="px-3 py-1 border border-slate-300 rounded hover:bg-slate-50 disabled:opacity-50" disabled>Anterior</button>
                    <button class="px-3 py-1 border border-slate-300 rounded hover:bg-slate-50 disabled:opacity-50" disabled>Próxima</button>
                </div>
            </div>
        </div>

    </main>

    <footer class="bg-white border-t border-slate-200 mt-12 py-8">
        <div class="max-w-7xl mx-auto px-4 text-center text-slate-400 text-sm">
            &copy; 2025 XV Analytics. Relatório confidencial de uso interno.
        </div>
    </footer>

    <script>
        // Inicializa ícones Lucide
        lucide.createIcons();

        // ==========================================
        // DADOS
        // ==========================================

        const datasets = {
            'nov2025': {
                total: 214, // Total atualizado
                data: [
                    { name: "ADAPTADOR TOMADA (BRINDE)", quantity: 7, percentage: 0.0327 },
                    { name: "BODY SPLASH. WEPINK (BRINDE)", quantity: 10, percentage: 0.0467 },
                    { name: "BOTICARIO(BRINDE)", quantity: 9, percentage: 0.0421 },
                    { name: "CABO KD 30 KAIDI", quantity: 2, percentage: 0.0093 },
                    { name: "CAPA HONOR X7C", quantity: 2, percentage: 0.0093 },
                    { name: "CAPA REDMI NOTE 13 PRO 4G", quantity: 1, percentage: 0.0047 },
                    { name: "CARREGADOR 20W KD KN-108A KDPAN", quantity: 2, percentage: 0.0093 },
                    { name: "CARREGADOR MOTOROLA 50W", quantity: 1, percentage: 0.0047 },
                    { name: "CARREGADOR XIAOMI 120W", quantity: 1, percentage: 0.0047 },
                    { name: "CHIP CLARO PREZÃO", quantity: 25, percentage: 0.1168 },
                    { name: "CHIP TIM PRE C REGARGA", quantity: 1, percentage: 0.0047 },
                    { name: "COPO STANLEY (BRINDE)", quantity: 6, percentage: 0.0280 },
                    { name: "DESCONTO NA VENDA", quantity: -18, percentage: -0.0841 },
                    { name: "FONE BLUETOOTH REDMI AIRDOTS (BRINDE)", quantity: 12, percentage: 0.0561 },
                    { name: "HONOR X7C 8/256 FOREST GREEN", quantity: 6, percentage: 0.0280 },
                    { name: "HONOR X7C 8/256 MIDNIGHT BLACK", quantity: 3, percentage: 0.0140 },
                    { name: "HONOR X7C 8/256 MOONLIGHT WHITE", quantity: 15, percentage: 0.0701 },
                    { name: "HONOR X8B 8/256 TITANIUM SILVER", quantity: 2, percentage: 0.0093 },
                    { name: "MOTO G05 4/128 VERDE", quantity: 5, percentage: 0.0234 },
                    { name: "MOTO G05 4/128 VERMELHO", quantity: 3, percentage: 0.0140 },
                    { name: "MOTO G15 4/128 CINZA", quantity: 3, percentage: 0.0140 },
                    { name: "MOTO G15 4/128 LARANJA", quantity: 2, percentage: 0.0093 },
                    { name: "MOTO G15 4/128 VERDE", quantity: 2, percentage: 0.0093 },
                    { name: "MOTO G15 8/256 GRAVITY GRAY", quantity: 1, percentage: 0.0047 },
                    { name: "MOTOROLA EDGE 50 5G FUSION 8/256 MARSHMALLOW BLUE", quantity: 2, percentage: 0.0093 },
                    { name: "PAGAMENTO NUOVO(PDV)", quantity: 11, percentage: 0.0514 },
                    { name: "PELICULA 3D A14/G10/G20/G9/E7/C53/13C/C61/C63/C65", quantity: 1, percentage: 0.0047 },
                    { name: "PELICULA 3D MOTO G22/E32/C53", quantity: 1, percentage: 0.0047 },
                    { name: "PELICULA HD HYDROGEL STANDARD", quantity: 58, percentage: 0.2710 },
                    { name: "PELICULA TRASEIRA DESENHOS", quantity: 1, percentage: 0.0047 },
                    { name: "REALME 14T 5G 8/256GB LIGHTNING PURPLE", quantity: 1, percentage: 0.0047 },
                    { name: "REALME C63 8/256 JADE GREEN", quantity: 3, percentage: 0.0140 },
                    { name: "REALME C63 8/256 LEATHER BLUE", quantity: 1, percentage: 0.0047 },
                    { name: "REALME C65 8/256 STARLIGHT BLACK", quantity: 1, percentage: 0.0047 },
                    { name: "REALME C71 8/256 WHITE SWAN", quantity: 6, percentage: 0.0280 },
                    { name: "REALME C75 8/256 RUBY RED", quantity: 3, percentage: 0.0140 },
                    { name: "REDMI A5 4/128 AZUL", quantity: 7, percentage: 0.0327 },
                    { name: "REDMI A5 4/128 GOLD", quantity: 6, percentage: 0.0280 },
                    { name: "REDMI A5 4/128 PRETO", quantity: 9, percentage: 0.0421 }
                ]
            },
            'out2025': {
                total: 208, // Total atualizado
                data: [
                    { name: "ADAPTADOR TOMADA (BRINDE)", quantity: 6, percentage: 0.0288 },
                    { name: "ASSISTÊNCIA SOFTWARE(PDV)", quantity: 1, percentage: 0.0048 },
                    { name: "CAPA HONOR X7C", quantity: 2, percentage: 0.0096 },
                    { name: "CAPA REDMI NOTE 13 PRO 4G", quantity: 2, percentage: 0.0096 },
                    { name: "CARREGADOR 20W KD 669CC KAIDI", quantity: 1, percentage: 0.0048 },
                    { name: "CARREGADOR MOTOROLA 50W", quantity: 2, percentage: 0.0096 },
                    { name: "CARREGADOR TURBO Y29-1 H'MASTON", quantity: 1, percentage: 0.0048 },
                    { name: "CHIP CLARO FLEX", quantity: 1, percentage: 0.0048 },
                    { name: "CHIP CLARO PREZÃO", quantity: 21, percentage: 0.1010 },
                    { name: "COPO STANLEY (BRINDE)", quantity: 19, percentage: 0.0913 },
                    { name: "DESCONTO NA VENDA", quantity: 7, percentage: 0.0337 },
                    { name: "FONE BLUETOOTH REDMI AIRDOTS (BRINDE)", quantity: 10, percentage: 0.0481 },
                    { name: "FONE COM FIO LE-0201 LELONG", quantity: 1, percentage: 0.0048 },
                    { name: "HONOR X7C 8/256 FOREST GREEN", quantity: 1, percentage: 0.0048 },
                    { name: "HONOR X7C 8/256 MOONLIGHT WHITE", quantity: 9, percentage: 0.0433 },
                    { name: "MOTO G05 4/128 VERMELHO", quantity: 1, percentage: 0.0048 },
                    { name: "MOTOROLA EDGE 50 5G 12/512 KOALA GREY", quantity: 1, percentage: 0.0048 },
                    { name: "MOTOROLA EDGE 50 5G 12/512 PEACH FUZZ", quantity: 1, percentage: 0.0048 },
                    { name: "PAGAMENTO NUOVO(PDV)", quantity: 4, percentage: 0.0192 },
                    { name: "PAGAMENTO PAYJOY(PDV)", quantity: 6, percentage: 0.0288 },
                    { name: "PELICULA 3D A14/G10/G20/G9/E7/C53/13C/C61/C63/C65", quantity: 1, percentage: 0.0048 },
                    { name: "PELICULA 3D NOTE 13 4G PRO", quantity: 2, percentage: 0.0096 },
                    { name: "PELICULA HD HYDROGEL STANDARD", quantity: 43, percentage: 0.2067 },
                    { name: "POCO C71 GOLD 4/128", quantity: 0, percentage: 0.0000 },
                    { name: "REALME 14T 5G 8/256GB OBSIDIAN BLACK", quantity: 1, percentage: 0.0048 },
                    { name: "REALME C71 8/256 FOREST OWL", quantity: 2, percentage: 0.0096 },
                    { name: "REALME C71 8/256 WHITE SWAN", quantity: 11, percentage: 0.0529 },
                    { name: "REALME C75 8/256 RUBY RED", quantity: 1, percentage: 0.0048 },
                    { name: "REALME C75X 8/256 CORAL PINK", quantity: 2, percentage: 0.0096 },
                    { name: "REDMI 14C 8/256 MIDNIGHT BLACK", quantity: 1, percentage: 0.0048 },
                    { name: "REDMI 14C 8/256 SAGE GREEN", quantity: 1, percentage: 0.0048 },
                    { name: "REDMI 14C 8/256 STARRY BLUE", quantity: 1, percentage: 0.0048 },
                    { name: "REDMI A5 4/128 AZUL", quantity: 15, percentage: 0.0721 },
                    { name: "REDMI A5 4/128 GOLD", quantity: 18, percentage: 0.0865 },
                    { name: "REDMI A5 4/128 PRETO", quantity: 11, percentage: 0.0529 },
                    { name: "REDMI NOTE 14 PRO 4G 8/256 PURPLE", quantity: 1, percentage: 0.0048 }
                ]
            }
        };

        // Paleta de cores profissional (Corporate Blue/Teal/Slate)
        const brandColors = [
            '#2563eb', '#0891b2', '#0d9488', '#4f46e5', '#7c3aed', 
            '#db2777', '#ea580c', '#65a30d', '#475569', '#64748b'
        ];

        let currentPeriod = 'nov2025';
        let sortState = { column: 'quantity', direction: 'desc' };
        let filteredData = []; 

        // --- Funções Auxiliares ---

        function generateColors(num) {
            const colors = [];
            for (let i = 0; i < num; i++) colors.push(brandColors[i % brandColors.length]);
            return colors;
        }

        // --- Renderização ---

        function renderTable(data) {
            const tbody = document.getElementById('product-table-body');
            tbody.innerHTML = '';

            if (data.length === 0) {
                tbody.innerHTML = `<tr><td colspan="5" class="px-6 py-8 text-center text-slate-400">Nenhum produto encontrado.</td></tr>`;
                document.getElementById('showing-text').innerText = `Mostrando 0 resultados`;
                return;
            }

            data.forEach((item, index) => {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-slate-50 transition-colors group';
                
                // Status Logic
                let statusBadge = `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">Ativo</span>`;
                if(item.name.includes("BRINDE")) statusBadge = `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-purple-100 text-purple-800">Brinde</span>`;
                if(item.name.includes("DESCONTO")) statusBadge = `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-amber-100 text-amber-800">Ajuste</span>`;
                if(item.quantity < 0) statusBadge = `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">Devolução</span>`;

                tr.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-center text-slate-400 font-mono text-xs">${index + 1}</td>
                    <td class="px-6 py-4 font-medium text-slate-700 group-hover:text-brand-700 transition-colors">${item.name}</td>
                    <td class="px-6 py-4 text-center">
                        <span class="inline-block font-bold text-slate-900 bg-slate-100 px-3 py-1 rounded-md min-w-[3rem]">${item.quantity}</span>
                    </td>
                    <td class="px-6 py-4 text-center">
                        <div class="flex items-center justify-center gap-2">
                            <span class="text-sm text-slate-600">${(item.percentage * 100).toFixed(2)}%</span>
                            <div class="w-16 bg-slate-200 rounded-full h-1.5 overflow-hidden">
                                <div class="bg-brand-500 h-1.5 rounded-full" style="width: ${Math.abs(item.percentage * 100)}%"></div>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4 text-center">${statusBadge}</td>
                `;
                tbody.appendChild(tr);
            });
            document.getElementById('showing-text').innerText = `Mostrando ${data.length} resultados`;
        }

        function renderPieLegend(data, colors) {
            const container = document.getElementById('pie-legend-container');
            container.innerHTML = '';
            
            // Filtra e limita para não quebrar o layout se forem muitos
            const legendData = data.filter(item => item.quantity > 0); 
            
            legendData.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'flex items-start gap-2 p-2 rounded hover:bg-slate-50 transition-colors';
                div.innerHTML = `
                    <span class="mt-1 block h-3 w-3 rounded-full flex-shrink-0" style="background-color: ${colors[index % colors.length]}"></span>
                    <div class="text-xs leading-tight">
                        <p class="font-medium text-slate-700 truncate w-32" title="${item.name}">${item.name}</p>
                        <p class="text-slate-400">${item.quantity} un. (${(item.percentage * 100).toFixed(1)}%)</p>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        // --- Charts ---

        function setupCharts(data) {
            const validData = data.filter(d => d.quantity > 0).sort((a,b) => b.quantity - a.quantity);
            const colors = generateColors(validData.length);

            // Pie Chart
            const pieCtx = document.getElementById('productPieChart').getContext('2d');
            if(window.pieChart) window.pieChart.destroy();
            
            window.pieChart = new Chart(pieCtx, {
                type: 'doughnut',
                data: {
                    labels: validData.map(d => d.name),
                    datasets: [{
                        data: validData.map(d => d.quantity),
                        backgroundColor: colors,
                        borderWidth: 0,
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '65%',
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(15, 23, 42, 0.9)',
                            padding: 12,
                            cornerRadius: 8,
                            callbacks: {
                                label: function(context) {
                                    const val = context.raw;
                                    const total = context.dataset.data.reduce((a,b) => a+b, 0);
                                    return ` ${val} un. (${((val/total)*100).toFixed(1)}%)`;
                                }
                            }
                        }
                    }
                }
            });

            // Bar Chart
            const top10 = validData.slice(0, 10);
            const topColors = generateColors(10);
            const barCtx = document.getElementById('productBarChart').getContext('2d');
            if(window.barChart) window.barChart.destroy();

            window.barChart = new Chart(barCtx, {
                type: 'bar',
                data: {
                    labels: top10.map(d => d.name.length > 20 ? d.name.substring(0,20)+'...' : d.name), // Truncate labels
                    datasets: [{
                        label: 'Vendas',
                        data: top10.map(d => d.quantity),
                        backgroundColor: topColors,
                        borderRadius: 6,
                        barThickness: 24
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(15, 23, 42, 0.9)',
                            padding: 12,
                            cornerRadius: 8,
                            displayColors: false,
                            callbacks: { title: (items) => top10[items[0].dataIndex].name } // Full name on hover
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: '#f1f5f9', drawBorder: false },
                            ticks: { color: '#64748b', font: {family: "'Plus Jakarta Sans'"}}
                        },
                        x: {
                            grid: { display: false, drawBorder: false },
                            ticks: { color: '#64748b', font: {family: "'Plus Jakarta Sans'", size: 10}}
                        }
                    }
                }
            });

            // Update Legend
            renderPieLegend(validData, colors);
        }

        // --- Logic ---

        function updateStats(periodData) {
            const data = periodData.data;
            const total = periodData.total;
            const unique = data.length;
            const topProduct = [...data].sort((a,b) => b.quantity - a.quantity)[0];

            document.getElementById('total-items').innerText = total;
            document.getElementById('unique-products').innerText = unique;
            if(topProduct) {
                const el = document.getElementById('top-product-name');
                el.innerText = topProduct.name;
                el.title = topProduct.name;
            }
        }

        function filterData(query) {
            const currentData = datasets[currentPeriod].data;
            const lower = query.toLowerCase();
            filteredData = currentData.filter(item => item.name.toLowerCase().includes(lower));
            // Re-apply sorting
            sortData(sortState.column, sortState.direction, false); 
        }

        function sortData(column, direction, updateUI = true) {
            sortState = { column, direction };
            
            filteredData.sort((a, b) => {
                let valA = a[column];
                let valB = b[column];
                
                if (typeof valA === 'string') return direction === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA);
                return direction === 'asc' ? valA - valB : valB - valA;
            });

            if(updateUI) renderTable(filteredData);
        }

        function loadPeriod(period) {
            currentPeriod = period;
            const periodData = datasets[period];
            const data = periodData.data;
            
            // UI Updates
            const label = period === 'nov2025' ? 'Novembro 2025' : 'Outubro 2025';
            document.getElementById('page-title').innerText = `Visão Geral - ${label}`;
            
            // Badge visual de crescimento
            const growthEl = document.getElementById('growth-badge');
            if (period === 'nov2025') {
                 // Nov: 214, Oct: 208. (214-208)/208 = 0.0288 -> +2.9%
                 growthEl.className = "text-xs font-semibold text-green-600 bg-green-50 px-2 py-1 rounded-full";
                 growthEl.innerText = "+2.9% vs. Outubro"; 
            } else {
                 growthEl.className = "text-xs font-semibold text-slate-500 bg-slate-100 px-2 py-1 rounded-full";
                 growthEl.innerText = "Base";
            }

            // Reset sort/filter
            data.sort((a, b) => b.quantity - a.quantity);
            filteredData = [...data];
            document.getElementById('table-search').value = '';

            // Render
            updateStats(periodData);
            setupCharts(data);
            renderTable(filteredData);
        }

        // --- Events ---

        document.getElementById('period-selector').addEventListener('change', (e) => {
            loadPeriod(e.target.value);
        });

        document.getElementById('table-search').addEventListener('input', (e) => {
            filterData(e.target.value);
        });

        document.getElementById('sort-by-name').addEventListener('click', () => {
            const dir = sortState.column === 'name' && sortState.direction === 'asc' ? 'desc' : 'asc';
            sortData('name', dir);
        });

        document.getElementById('sort-by-quantity').addEventListener('click', () => {
            const dir = sortState.column === 'quantity' && sortState.direction === 'desc' ? 'asc' : 'desc';
            sortData('quantity', dir);
        });
        
        document.getElementById('sort-by-percentage').addEventListener('click', () => {
            const dir = sortState.column === 'percentage' && sortState.direction === 'desc' ? 'asc' : 'desc';
            sortData('percentage', dir);
        });

        // --- Init ---
        
        (function init() {
            loadPeriod('nov2025');
        })();

    </script>
</body>
</html>